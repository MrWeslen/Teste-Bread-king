<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Pesquisa de Satisfa√ß√£o</title>
<style>
  :root { --pad: clamp(12px, 3vw, 24px); --radius: 24px; --maxw: 900px; }
  html, body { height: 100%; margin: 0; background:#0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .wrap { min-height: 100%; display: grid; place-items: center; padding: var(--pad); }
  .card { width: 100%; max-width: var(--maxw); background:#101722; border-radius: var(--radius);
          box-shadow: 0 10px 40px rgba(0,0,0,.35); color:#e6eefc; padding: clamp(16px, 3vw, 28px); }
  .header { display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
  .amount { font-size: clamp(28px, 6vw, 56px); font-weight: 800; letter-spacing:.5px; }
  .sub { opacity:.75; font-size: clamp(12px, 2.2vw, 16px); }
  .keypad { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-block: 14px 6px; }
  .keypad button { font-size: clamp(18px, 4.6vw, 28px); padding: 14px 10px; border:none; border-radius: 16px; background:#1a2332; color:#e6eefc; }
  .keypad button:active { transform: scale(.97); }
  .row { display:grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: clamp(14px, 2.6vw, 24px); }
  .btn { border:0; border-radius: 22px; padding: clamp(16px, 3.2vw, 28px); font-size: clamp(16px, 3.4vw, 24px); font-weight: 700; color:#0b0f14; }
  .btn.green { background:#87f58a; }
  .btn.yellow{ background:#ffe37e; }
  .btn.red   { background:#ff8b8b; }
  .status { text-align:center; margin-top: 14px; min-height: 28px; font-weight:600; }
  .success { color:#87f58a; } .error { color:#ff8b8b; }
  .sm { font-size: .95rem; opacity:.8; }
  .device { opacity:.6; font-size:.9rem; text-align:center; margin-top: 6px; }
  .hidden { display:none; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="app">
    <div class="header">
      <div>
        <div class="sub">Valor da compra</div>
        <div class="amount" id="amountDisplay">R$ 0,00</div>
      </div>
      <div class="sub">Toque para digitar ou passe o valor pela URL (?amount=123.45)</div>
    </div>

    <!-- Teclado num√©rico -->
    <div class="keypad" aria-label="Teclado num√©rico">
      <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
      <button data-k="del">‚å´</button>
      <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
      <button data-k="clr">Limpar</button>
      <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
      <button data-k="00">00</button>
      <button data-k="0">0</button><button data-k=",">,</button><button data-k="enter" style="grid-column: span 2;">OK</button>
    </div>

    <!-- Bot√µes de avalia√ß√£o -->
    <div class="row">
      <button class="btn green"  data-rating="muito_satisfeito">üòÄ Muito satisfeito</button>
      <button class="btn yellow" data-rating="satisfeito">üôÇ Satisfeito</button>
      <button class="btn red"    data-rating="insatisfeito">‚òπÔ∏è Insatisfeito</button>
    </div>

    <div class="status" id="status"></div>
    <div class="device" id="deviceInfo"></div>
    <div class="sm hidden" id="hint">Toque em uma op√ß√£o para enviar.</div>
  </div>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbxNGGAA3VCJ_iZpFeToWcOwwFo_rDw8B5UjlInbIwCgi_CNJt3voAOCE-koTjzxu5KJ7w/exec";   // ‚Üê cole aqui
const DEVICE_ID = "loja Moema - caixa 01";      // personalize por tablet/caixa

// --- estado do valor ---
let raw = ""; // guarda apenas d√≠gitos (centavos)
const disp = document.getElementById("amountDisplay");
const statusEl = document.getElementById("status");
const deviceEl = document.getElementById("deviceInfo");
deviceEl.textContent = `Dispositivo: ${DEVICE_ID}`;

function formatBRL(centsStr) {
  const val = (Number(centsStr || "0") / 100).toFixed(2);
  return new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(val);
}
function refresh() { disp.textContent = formatBRL(raw); }

function setFromQuery() {
  const p = new URLSearchParams(location.search);
  const a = p.get("amount");
  if (!a) return;
  const normalized = String(a).replace(/[^\d,.\-]/g,"").replace(",",".");
  const num = Math.round(parseFloat(normalized) * 100);
  if (!isNaN(num) && num >= 0) { raw = String(num); refresh(); }
}
setFromQuery(); refresh();

// teclado
document.querySelector(".keypad").addEventListener("click", (e) => {
  const k = e.target.getAttribute("data-k"); if (!k) return;
  if (k === "del") { raw = raw.slice(0, -1); }
  else if (k === "clr") { raw = ""; }
  else if (k === ",")  { /* v√≠rgula s√≥ visual; ignoramos */ }
  else if (k === "enter") { /* nada: valor j√° aparece */ }
  else { raw += k.replace(/\D/g,""); }
  refresh();
});

// envio
async function send(rating) {
  statusEl.textContent = "Enviando‚Ä¶";
  statusEl.className = "status";

  const payload = {
    device_id: DEVICE_ID,
    rating,
    amount: (Number(raw || "0") / 100).toFixed(2),
    notes: "",
    ua: navigator.userAgent
  };

  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      mode: "no-cors",      // Apps Script aceita; evita erro CORS visual
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    // sem CORS n√£o temos status, ent√£o mostramos sucesso direto:
    statusEl.textContent = "Obrigado! Resposta registrada.";
    statusEl.className = "status success";
    setTimeout(() => { statusEl.textContent = ""; raw = ""; refresh(); }, 1200);
  } catch (err) {
    statusEl.textContent = "Falha ao enviar. Verifique a conex√£o.";
    statusEl.className = "status error";
  }
}

document.querySelectorAll("[data-rating]").forEach(btn => {
  btn.addEventListener("click", () => send(btn.dataset.rating));
});

// mant√©m a tela acordada (quando suportado)
if ('wakeLock' in navigator) {
  let lock;
  const req = async () => { try { lock = await navigator.wakeLock.request('screen'); } catch(e){} };
  req(); document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') req(); });
}
</script>
</body>
</html>
